\doxysection{unit-\/ray-\/staging-\/buffer.hpp}
\hypertarget{unit-ray-staging-buffer_8hpp_source}{}\label{unit-ray-staging-buffer_8hpp_source}\index{C:/Users/u1320313/Dev/arches-\/v2/arches-\/v2/src/arches/units/dual-\/streaming/unit-\/ray-\/staging-\/buffer.hpp@{C:/Users/u1320313/Dev/arches-\/v2/arches-\/v2/src/arches/units/dual-\/streaming/unit-\/ray-\/staging-\/buffer.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once\ }}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#include\ "{}../../../stdafx.hpp"{}}}
\DoxyCodeLine{00003\ }
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ "{}../unit-\/base.hpp"{}}}
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ "{}../unit-\/memory-\/base.hpp"{}}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ "{}unit-\/stream-\/scheduler.hpp"{}}}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ "{}../../../../benchmarks/dual-\/streaming/src/ray.hpp"{}}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ }
\DoxyCodeLine{00011\ \textcolor{keyword}{namespace\ }Arches\ \{\ \textcolor{keyword}{namespace\ }Units\ \{\ \textcolor{keyword}{namespace\ }DualStreaming\ \{}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ }
\DoxyCodeLine{00014\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{struct_arches_1_1_units_1_1_dual_streaming_1_1_ray_bucket_buffer}{RayBucketBuffer}}}
\DoxyCodeLine{00015\ \{}
\DoxyCodeLine{00016\ \ \ \ \ \textcolor{keyword}{union}}
\DoxyCodeLine{00017\ \ \ \ \ \{}
\DoxyCodeLine{00018\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_arches_1_1_units_1_1_dual_streaming_1_1_ray_bucket}{RayBucket}}\ ray\_bucket;}
\DoxyCodeLine{00019\ \ \ \ \ \ \ \ \ uint8\_t\ data\_u8[RAY\_BUCKET\_SIZE];}
\DoxyCodeLine{00020\ \ \ \ \ \};}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \ \ \ \ \textcolor{keywordtype}{bool}\ requested\{\textcolor{keyword}{false}\};}
\DoxyCodeLine{00023\ \ \ \ \ uint\ next\_ray\{0\};}
\DoxyCodeLine{00024\ \ \ \ \ uint\ bytes\_returned\{0\};}
\DoxyCodeLine{00025\ }
\DoxyCodeLine{00026\ \ \ \ \ \mbox{\hyperlink{struct_arches_1_1_units_1_1_dual_streaming_1_1_ray_bucket_buffer}{RayBucketBuffer}}()\ }
\DoxyCodeLine{00027\ \ \ \ \ \{}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ ray\_bucket.num\_rays\ =\ 0;}
\DoxyCodeLine{00029\ \ \ \ \ \}}
\DoxyCodeLine{00030\ \};}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00032\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_arches_1_1_units_1_1_dual_streaming_1_1_unit_ray_staging_buffer}{UnitRayStagingBuffer}}\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{class_arches_1_1_units_1_1_unit_memory_base}{UnitMemoryBase}}}
\DoxyCodeLine{00033\ \{}
\DoxyCodeLine{00034\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00035\ \ \ \ \ \mbox{\hyperlink{class_arches_1_1_units_1_1_dual_streaming_1_1_unit_ray_staging_buffer}{UnitRayStagingBuffer}}(uint\ num\_tp,\ uint\ tm\_index,\ \mbox{\hyperlink{class_arches_1_1_units_1_1_dual_streaming_1_1_unit_stream_scheduler}{UnitStreamScheduler}}*\ stream\_scheduler)\ :\ \mbox{\hyperlink{class_arches_1_1_units_1_1_unit_memory_base}{UnitMemoryBase}}(num\_tp,\ 1),\ tm\_index(tm\_index)}
\DoxyCodeLine{00036\ \ \ \ \ \{}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ front\_buffer\ =\ \&ray\_buffer[0];}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ back\_buffer\ =\ \&ray\_buffer[1];}
\DoxyCodeLine{00039\ \ \ \ \ \}}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \ \ \ \ \mbox{\hyperlink{class_arches_1_1_units_1_1_dual_streaming_1_1_unit_stream_scheduler}{UnitStreamScheduler}}*\ stream\_scheduler;}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \ \ \ \ uint\ tm\_index;}
\DoxyCodeLine{00044\ }
\DoxyCodeLine{00045\ \ \ \ \ \mbox{\hyperlink{struct_arches_1_1_units_1_1_dual_streaming_1_1_ray_bucket_buffer}{RayBucketBuffer}}*\ front\_buffer;}
\DoxyCodeLine{00046\ \ \ \ \ \mbox{\hyperlink{struct_arches_1_1_units_1_1_dual_streaming_1_1_ray_bucket_buffer}{RayBucketBuffer}}*\ back\_buffer;}
\DoxyCodeLine{00047\ \ \ \ \ \mbox{\hyperlink{struct_arches_1_1_units_1_1_dual_streaming_1_1_ray_bucket_buffer}{RayBucketBuffer}}\ ray\_buffer[2];}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \ \ \ \ uint\ request\_index\{\string~0u\};}
\DoxyCodeLine{00050\ \ \ \ \ \mbox{\hyperlink{struct_arches_1_1_units_1_1_memory_request}{MemoryRequest}}\ request;}
\DoxyCodeLine{00051\ }
\DoxyCodeLine{00052\ \ \ \ \ \textcolor{keywordtype}{void}\ clock\_rise()\textcolor{keyword}{\ override}}
\DoxyCodeLine{00053\ \textcolor{keyword}{\ \ \ \ }\{}
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ \textcolor{comment}{//requests}}
\DoxyCodeLine{00055\ \ \ \ \ \ \ \ \ interconnect.propagate\_requests([](\textcolor{keyword}{const}\ \mbox{\hyperlink{struct_arches_1_1_units_1_1_memory_request}{MemoryRequest}}\&\ \mbox{\hyperlink{structreq}{req}},\ uint\ client,\ uint\ num\_clients,\ uint\ num\_servers)-\/>uint}
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \});}
\DoxyCodeLine{00059\ }
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(request\_index\ ==\ \string~0u)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ uint\ port\_index;}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_arches_1_1_units_1_1_memory_request}{MemoryRequest}}*\ \mbox{\hyperlink{structreq}{req}}\ =\ interconnect.get\_request(0,\ port\_index);}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{structreq}{req}})}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \ \ \ \ request\ =\ *\mbox{\hyperlink{structreq}{req}};}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \ \ \ \ request\_index\ =\ port\_index;}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \ \ \ \ interconnect.acknowlege\_request(0,\ port\_index);}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00070\ }
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \textcolor{comment}{//returns}}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{struct_arches_1_1_units_1_1_memory_return}{MemoryReturn}}*\ ret\ =\ stream\_scheduler-\/>interconnect.get\_return(tm\_index);}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(ret)}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \ \ \ \ uint\ buffer\_address\ =\ ret-\/>paddr\ \%\ RAY\_BUCKET\_SIZE;}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ \ \ \ std::memcpy(\&back\_buffer-\/>data\_u8[buffer\_address],\ ret-\/>data,\ ret-\/>size);}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ \ \ \ stream\_scheduler-\/>interconnect.acknowlege\_return(tm\_index);}
\DoxyCodeLine{00078\ }
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \ \ \ \ back\_buffer-\/>bytes\_returned\ +=\ ret-\/>size;}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00081\ \ \ \ \ \}}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keywordtype}{void}\ clock\_fall()\textcolor{keyword}{\ override}}
\DoxyCodeLine{00084\ \textcolor{keyword}{\ \ \ \ }\{}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ interconnect.propagate\_ack();}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \textcolor{comment}{//requests}}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(front\_buffer-\/>next\_ray\ ==\ front\_buffer-\/>ray\_bucket.num\_rays\ \&\&}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ back\_buffer-\/>bytes\_returned\ ==\ RAY\_BUCKET\_SIZE)}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//swap\ buffers}}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ std::swap(front\_buffer,\ back\_buffer);}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00094\ }
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!back\_buffer-\/>requested)}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_arches_1_1_units_1_1_memory_request}{MemoryRequest}}\ \mbox{\hyperlink{structreq}{req}};}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structreq}{req}}.type\ =\ MemoryRequest::Type::LOAD\_RAY\_BUCKET;}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structreq}{req}}.size\ =\ RAY\_BUCKET\_SIZE;}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structreq}{req}}.paddr\ =\ 0x0;}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ stream\_scheduler-\/>interconnect.add\_request(\mbox{\hyperlink{structreq}{req}},\ tm\_index);}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ \ \ back\_buffer-\/>requested\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \textcolor{comment}{//returns}}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(request\_index\ ==\ \string~0u)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{00107\ }
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(request.type\ ==\ MemoryRequest::Type::LBRAY)}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//if\ we\ have\ a\ filled\ bucket\ pop\ a\ ray\ from\ it\ otherwise\ stall}}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(front\_buffer-\/>next\_ray\ <\ front\_buffer-\/>ray\_bucket.num\_rays)}
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{struct_arches_1_1_units_1_1_memory_return}{MemoryReturn}}\ ret;}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ret.type\ ==\ MemoryReturn::Type::LOAD\_RETURN;}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ret.size\ =\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{struct_bucket_ray}{BucketRay}});}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ret.paddr\ =\ 0x0ull;}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ret.data\ =\ \&front\_buffer-\/>ray\_bucket.bucket\_rays[front\_buffer-\/>next\_ray];}
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ interconnect.add\_return(ret,\ 0,\ request\_index);}
\DoxyCodeLine{00119\ }
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ front\_buffer-\/>next\_ray++;}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}(request.type\ ==\ MemoryRequest::Type::SBRAY\ ||\ request.type\ ==\ MemoryRequest::Type::CSHIT)\ \textcolor{comment}{//ray\ write\ or\ conditionally\ store\ hit}}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//forward\ to\ stream\ scheduler}}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!stream\_scheduler-\/>interconnect.request\_pending(tm\_index))}
\DoxyCodeLine{00127\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ stream\_scheduler-\/>interconnect.add\_request(request,\ tm\_index);}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ interconnect.propagate\_returns();}
\DoxyCodeLine{00133\ \ \ \ \ \}}
\DoxyCodeLine{00134\ \};}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \}\}\}}

\end{DoxyCode}
