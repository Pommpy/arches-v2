\doxysection{trax.\+hpp}
\hypertarget{trax_8hpp_source}{}\label{trax_8hpp_source}\index{C:/Users/u1320313/Dev/arches-\/v2/arches-\/v2/src/trax.hpp@{C:/Users/u1320313/Dev/arches-\/v2/arches-\/v2/src/trax.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ "{}arches/simulator/simulator.hpp"{}}}
\DoxyCodeLine{00004\ }
\DoxyCodeLine{00005\ \textcolor{preprocessor}{\#include\ "{}arches/units/unit-\/dram.hpp"{}}}
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ "{}arches/units/unit-\/cache.hpp"{}}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ "{}arches/units/unit-\/atomic-\/reg-\/file.hpp"{}}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ "{}arches/units/unit-\/tile-\/scheduler.hpp"{}}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ "{}arches/units/unit-\/sfu.hpp"{}}}
\DoxyCodeLine{00011\ \textcolor{preprocessor}{\#include\ "{}arches/units/unit-\/tp.hpp"{}}}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ "{}arches/util/elf.hpp"{}}}
\DoxyCodeLine{00014\ }
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ "{}../benchmarks/trax/src/ray-\/tracing-\/include.hpp"{}}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{keyword}{namespace\ }Arches\ \{}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{keyword}{namespace\ }ISA\ \{\ \textcolor{keyword}{namespace\ }RISCV\ \{\ \textcolor{keyword}{namespace\ }TRaX\ \{}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{comment}{//TRAXAMOIN}}
\DoxyCodeLine{00023\ \textcolor{keyword}{const}\ \textcolor{keyword}{static}\ InstructionInfo\ traxamoin(0b00010,\ \textcolor{stringliteral}{"{}traxamoin"{}},\ Type::FCHTHRD,\ Encoding::U,\ RegFile::INT,\ IMPL\_DECL}
\DoxyCodeLine{00024\ \{}
\DoxyCodeLine{00025\ \ \ \ \ unit-\/>mem\_req.type\ =\ Units::MemoryRequest::Type::FCHTHRD;}
\DoxyCodeLine{00026\ \ \ \ \ unit-\/>mem\_req.dst.reg\ =\ instr.i.rd;}
\DoxyCodeLine{00027\ \ \ \ \ unit-\/>mem\_req.dst.reg\_file\ =\ 0;}
\DoxyCodeLine{00028\ \ \ \ \ unit-\/>mem\_req.dst.sign\_ext\ =\ 0;}
\DoxyCodeLine{00029\ \ \ \ \ unit-\/>mem\_req.size\ =\ 4;}
\DoxyCodeLine{00030\ \ \ \ \ unit-\/>mem\_req.vaddr\ =\ 0x0ull;}
\DoxyCodeLine{00031\ \});}
\DoxyCodeLine{00032\ \}\}\}}
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \textcolor{keyword}{static}\ paddr\_t\ align\_to(\textcolor{keywordtype}{size\_t}\ alignment,\ paddr\_t\ paddr)}
\DoxyCodeLine{00036\ \{}
\DoxyCodeLine{00037\ \ \ \ \ \textcolor{keywordflow}{return}\ (paddr\ +\ alignment\ -\/\ 1)\ \&\ \string~(alignment\ -\/\ 1);}
\DoxyCodeLine{00038\ \}}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ RET>}
\DoxyCodeLine{00041\ \textcolor{keyword}{static}\ RET*\ write\_array(Units::UnitMainMemoryBase*\ main\_memory,\ \textcolor{keywordtype}{size\_t}\ alignment,\ RET*\ data,\ \textcolor{keywordtype}{size\_t}\ size,\ paddr\_t\&\ heap\_address)}
\DoxyCodeLine{00042\ \{}
\DoxyCodeLine{00043\ \ \ \ \ paddr\_t\ array\_address\ =\ align\_to(alignment,\ heap\_address);}
\DoxyCodeLine{00044\ \ \ \ \ heap\_address\ =\ array\_address\ +\ size\ *\ \textcolor{keyword}{sizeof}(RET);}
\DoxyCodeLine{00045\ \ \ \ \ main\_memory-\/>direct\_write(data,\ size\ *\ \textcolor{keyword}{sizeof}(RET),\ array\_address);}
\DoxyCodeLine{00046\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{reinterpret\_cast<}RET*\textcolor{keyword}{>}(array\_address);}
\DoxyCodeLine{00047\ \}}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00049\ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ RET>}
\DoxyCodeLine{00050\ \textcolor{keyword}{static}\ RET*\ write\_vector(Units::UnitMainMemoryBase*\ main\_memory,\ \textcolor{keywordtype}{size\_t}\ alignment,\ std::vector<RET>\ v,\ paddr\_t\&\ heap\_address)}
\DoxyCodeLine{00051\ \{}
\DoxyCodeLine{00052\ \ \ \ \ \textcolor{keywordflow}{return}\ write\_array(main\_memory,\ alignment,\ v.data(),\ v.size(),\ heap\_address);}
\DoxyCodeLine{00053\ \}}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00055\ \textcolor{keyword}{static}\ \mbox{\hyperlink{struct_global_data}{GlobalData}}\ initilize\_buffers(Units::UnitMainMemoryBase*\ main\_memory,\ paddr\_t\&\ heap\_address)}
\DoxyCodeLine{00056\ \{}
\DoxyCodeLine{00057\ \ \ \ \ \mbox{\hyperlink{struct_global_data}{GlobalData}}\ global\_data;}
\DoxyCodeLine{00058\ \ \ \ \ global\_data.framebuffer\_width\ =\ 1024;}
\DoxyCodeLine{00059\ \ \ \ \ global\_data.framebuffer\_height\ =\ 1024;}
\DoxyCodeLine{00060\ \ \ \ \ global\_data.framebuffer\_size\ =\ global\_data.framebuffer\_width\ *\ global\_data.framebuffer\_height;}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00062\ \ \ \ \ heap\_address\ =\ align\_to(4\ *\ 1024,\ heap\_address);}
\DoxyCodeLine{00063\ \ \ \ \ global\_data.framebuffer\ =\ \textcolor{keyword}{reinterpret\_cast<}uint32\_t*\textcolor{keyword}{>}(heap\_address);\ heap\_address\ +=\ global\_data.framebuffer\_size\ *\ \textcolor{keyword}{sizeof}(uint32\_t);}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \ \ \ \ global\_data.samples\_per\_pixel\ =\ 1;}
\DoxyCodeLine{00066\ \ \ \ \ global\_data.max\_bounces\ =\ 0;}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \ \ \ \ global\_data.light\_dir\ =\ rtm::normalize(\mbox{\hyperlink{classrtm_1_1vec3}{rtm::vec3}}(4.5f,\ 42.5f,\ 5.0f));}
\DoxyCodeLine{00069\ \ \ \ \ global\_data.camera\ =\ \mbox{\hyperlink{class_camera}{Camera}}(global\_data.framebuffer\_width,\ global\_data.framebuffer\_height,\ 12.0f,\ \mbox{\hyperlink{classrtm_1_1vec3}{rtm::vec3}}(-\/900.6f,\ 150.8f,\ 120.74f),\ \mbox{\hyperlink{classrtm_1_1vec3}{rtm::vec3}}(79.7f,\ 14.0f,\ -\/17.4f));}
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{comment}{//global\_data.camera\ =\ Camera(global\_data.framebuffer\_width,\ global\_data.framebuffer\_height,\ 24.0f,\ rtm::vec3(0.0f,\ 0.0f,\ 5.0f));}}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00072\ \ \ \ \ \mbox{\hyperlink{class_mesh}{Mesh}}\ mesh(\textcolor{stringliteral}{"{}benchmarks/trax/res/sponza2\_triangulated.obj"{}});}
\DoxyCodeLine{00073\ \ \ \ \ \mbox{\hyperlink{class_b_v_h}{BVH}}\ blas;}
\DoxyCodeLine{00074\ \ \ \ \ std::vector<BuildObject>\ build\_objects;}
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{keywordflow}{for}(uint\ i\ =\ 0;\ i\ <\ mesh.size();\ ++i)}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ build\_objects.push\_back(mesh.get\_build\_object(i));}
\DoxyCodeLine{00077\ \ \ \ \ blas.build(build\_objects);}
\DoxyCodeLine{00078\ \ \ \ \ mesh.reorder(build\_objects);}
\DoxyCodeLine{00079\ }
\DoxyCodeLine{00080\ \ \ \ \ global\_data.mesh.blas\ =\ write\_vector(main\_memory,\ CACHE\_BLOCK\_SIZE,\ blas.nodes,\ heap\_address);}
\DoxyCodeLine{00081\ \ \ \ \ global\_data.mesh.vertex\_indices\ =\ write\_vector(main\_memory,\ CACHE\_BLOCK\_SIZE,\ mesh.vertex\_indices,\ heap\_address);}
\DoxyCodeLine{00082\ \ \ \ \ global\_data.mesh.vertices\ =\ write\_vector(main\_memory,\ CACHE\_BLOCK\_SIZE,\ mesh.vertices,\ heap\_address);}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \ \ \ \ main\_memory-\/>direct\_write(\&global\_data,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{struct_global_data}{GlobalData}}),\ GLOBAL\_DATA\_ADDRESS);}
\DoxyCodeLine{00085\ }
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{keywordflow}{return}\ global\_data;}
\DoxyCodeLine{00087\ \}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ run\_sim\_trax(\textcolor{keywordtype}{int}\ argc,\ \textcolor{keywordtype}{char}*\ argv[])}
\DoxyCodeLine{00090\ \{}
\DoxyCodeLine{00091\ \ \ \ \ uint\ num\_tps\_per\_tm\ =\ 32;}
\DoxyCodeLine{00092\ \ \ \ \ uint\ num\_tms\_per\_l2\ =\ 8;}
\DoxyCodeLine{00093\ \ \ \ \ uint\ num\_l2\ =\ 4;}
\DoxyCodeLine{00094\ }
\DoxyCodeLine{00095\ \ \ \ \ uint\ num\_tps\ =\ num\_l2\ *\ num\_tms\_per\_l2\ *\ num\_l2;}
\DoxyCodeLine{00096\ \ \ \ \ uint\ num\_tms\ =\ num\_tms\_per\_l2\ *\ num\_l2;}
\DoxyCodeLine{00097\ \ \ \ \ uint\ sfu\_table\_size\ =\ \textcolor{keyword}{static\_cast<}uint\textcolor{keyword}{>}(ISA::RISCV::Type::NUM\_TYPES);}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00099\ \ \ \ \ \textcolor{comment}{//hardware\ spec}}
\DoxyCodeLine{00100\ \ \ \ \ uint64\_t\ mem\_size\ =\ 4ull\ *\ 1024ull\ *\ 1024ull\ *\ 1024ull;\ \textcolor{comment}{//4GB}}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00102\ \ \ \ \ \textcolor{comment}{//cached\ global\ data}}
\DoxyCodeLine{00103\ \ \ \ \ uint64\_t\ stack\_size\ =\ 2048;\ \textcolor{comment}{//2KB}}
\DoxyCodeLine{00104\ \ \ \ \ uint64\_t\ global\_data\_size\ =\ 64\ *\ 1024;\ \textcolor{comment}{//64KB\ for\ global\ data}}
\DoxyCodeLine{00105\ \ \ \ \ uint64\_t\ binary\_size\ =\ 64\ *\ 1024;\ \textcolor{comment}{//64KB\ for\ executable\ data}}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{comment}{//global\ data}}
\DoxyCodeLine{00108\ \ \ \ \ vaddr\_t\ mm\_null\_address\ =\ 0x0ull;}
\DoxyCodeLine{00109\ \ \ \ \ vaddr\_t\ mm\_global\_data\_start\ =\ GLOBAL\_DATA\_ADDRESS;}
\DoxyCodeLine{00110\ \ \ \ \ vaddr\_t\ mm\_binary\_start\ =\ mm\_global\_data\_start\ +\ global\_data\_size;}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \ \ vaddr\_t\ mm\_heap\_start\ =\ mm\_binary\_start\ +\ binary\_size;}
\DoxyCodeLine{00113\ }
\DoxyCodeLine{00114\ \ \ \ \ vaddr\_t\ mm\_stack\_start\ =\ mem\_size\ -\/\ stack\_size;}
\DoxyCodeLine{00115\ \ \ \ \ vaddr\_t\ stack\_pointer\ =\ mem\_size;}
\DoxyCodeLine{00116\ }
\DoxyCodeLine{00117\ \ \ \ \ ISA::RISCV::isa[ISA::RISCV::CUSTOM\_OPCODE0]\ =\ ISA::RISCV::TRaX::traxamoin;}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00119\ \ \ \ \ Simulator\ simulator;}
\DoxyCodeLine{00120\ }
\DoxyCodeLine{00121\ \ \ \ \ std::vector<Units::UnitTP*>\ tps;}
\DoxyCodeLine{00122\ \ \ \ \ std::vector<Units::UnitSFU*>\ sfus;}
\DoxyCodeLine{00123\ \ \ \ \ std::vector<Units::UnitCache*>\ l1s;}
\DoxyCodeLine{00124\ \ \ \ \ std::vector<Units::UnitCache*>\ l2s;}
\DoxyCodeLine{00125\ \ \ \ \ std::vector<Units::UnitThreadScheduler*>\ thread\_schedulers;}
\DoxyCodeLine{00126\ }
\DoxyCodeLine{00127\ \ \ \ \ std::vector<Units::UnitSFU*>\ sfu\_tables(sfu\_table\_size\ *\ num\_tms);}
\DoxyCodeLine{00128\ \ \ \ \ }
\DoxyCodeLine{00129\ \ \ \ \ Units::UnitDRAM\ mm(num\_l2,\ 1024ull\ *\ 1024ull\ *\ 1024ull,\ \&simulator);\ mm.clear();}
\DoxyCodeLine{00130\ \ \ \ \ simulator.register\_unit(\&mm);}
\DoxyCodeLine{00131\ \ \ \ \ }
\DoxyCodeLine{00132\ \ \ \ \ ELF\ elf(\textcolor{stringliteral}{"{}benchmarks/trax/bin/riscv/path-\/tracer"{}});}
\DoxyCodeLine{00133\ \ \ \ \ vaddr\_t\ global\_pointer;}
\DoxyCodeLine{00134\ \ \ \ \ paddr\_t\ heap\_address\ =\ mm.write\_elf(elf);}
\DoxyCodeLine{00135\ \ \ \ \ }
\DoxyCodeLine{00136\ \ \ \ \ \mbox{\hyperlink{struct_global_data}{GlobalData}}\ global\_data\ =\ initilize\_buffers(\&mm,\ heap\_address);}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \ \ \ \ Units::UnitAtomicRegfile\ atomic\_regs(num\_tms);}
\DoxyCodeLine{00139\ \ \ \ \ simulator.register\_unit(\&atomic\_regs);}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00141\ \ \ \ \ \textcolor{keywordflow}{for}(uint\ l2\_index\ =\ 0;\ l2\_index\ <\ num\_l2;\ ++l2\_index)}
\DoxyCodeLine{00142\ \ \ \ \ \{}
\DoxyCodeLine{00143\ \ \ \ \ \ \ \ \ Units::UnitCache::Configuration\ l2\_config;}
\DoxyCodeLine{00144\ \ \ \ \ \ \ \ \ l2\_config.size\ =\ 512\ *\ 1024;}
\DoxyCodeLine{00145\ \ \ \ \ \ \ \ \ l2\_config.associativity\ =\ 1;}
\DoxyCodeLine{00146\ \ \ \ \ \ \ \ \ l2\_config.data\_array\_access\_cycles\ =\ 3;}
\DoxyCodeLine{00147\ \ \ \ \ \ \ \ \ l2\_config.num\_ports\ =\ num\_tms\_per\_l2;}
\DoxyCodeLine{00148\ \ \ \ \ \ \ \ \ l2\_config.num\_banks\ =\ 16;}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ l2\_config.num\_lfb\ =\ 4;}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ l2\_config.mem\_map.add\_unit(mm\_null\_address,\ \&mm,\ l2\_index,\ 1);}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ l2s.push\_back(\textcolor{keyword}{new}\ Units::UnitCache(l2\_config));}
\DoxyCodeLine{00153\ }
\DoxyCodeLine{00154\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(uint\ tm\_i\ =\ 0;\ tm\_i\ <\ num\_tms\_per\_l2;\ ++tm\_i)}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ simulator.start\_new\_unit\_group();}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(tm\_i\ ==\ 0)\ simulator.register\_unit(l2s.back());}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ \ \ uint\ tm\_index\ =\ l2\_index\ *\ num\_tms\_per\_l2\ +\ tm\_i;}
\DoxyCodeLine{00160\ }
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \ \ \ \ Units::UnitCache::Configuration\ l1\_config;}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \ \ \ \ l1\_config.size\ =\ 32\ *\ 1024;}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \ \ \ \ l1\_config.associativity\ =\ 1;}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \ \ \ \ l1\_config.data\_array\_access\_cycles\ =\ 1;}
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \ \ \ \ l1\_config.num\_ports\ =\ num\_tps\_per\_tm;}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ \ \ \ \ l1\_config.port\_size\ =\ 16;}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ \ \ \ \ l1\_config.num\_banks\ =\ 8;}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ \ \ \ \ l1\_config.num\_lfb\ =\ 4;}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ \ \ \ \ l1\_config.mem\_map.add\_unit(mm\_null\_address,\ l2s.back(),\ tm\_i,\ 1);}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \ \ \ \ l1s.push\_back(\textcolor{keyword}{new}\ Units::UnitCache(l1\_config));}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ \ \ \ \ simulator.register\_unit(l1s.back());}
\DoxyCodeLine{00173\ }
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ \ \ \ \ Units::UnitSFU**\ sfu\_table\ =\ \&sfu\_tables[sfu\_table\_size\ *\ tm\_index];}
\DoxyCodeLine{00175\ }
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ \ \ \ \ sfus.push\_back(\_new\ Units::UnitSFU(16,\ 1,\ 2,\ num\_tps\_per\_tm));}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ \ \ simulator.register\_unit(sfus.back());}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \ \ \ \ \ \ sfu\_table[\textcolor{keyword}{static\_cast<}uint\textcolor{keyword}{>}(ISA::RISCV::Type::FADD)]\ =\ sfus.back();}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ \ \ \ \ sfu\_table[\textcolor{keyword}{static\_cast<}uint\textcolor{keyword}{>}(ISA::RISCV::Type::FMUL)]\ =\ sfus.back();}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ \ \ \ \ sfu\_table[\textcolor{keyword}{static\_cast<}uint\textcolor{keyword}{>}(ISA::RISCV::Type::FFMAD)]\ =\ sfus.back();}
\DoxyCodeLine{00181\ }
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ \ \ \ \ sfus.push\_back(\_new\ Units::UnitSFU(2,\ 1,\ 1,\ num\_tps\_per\_tm));}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \ \ \ \ simulator.register\_unit(sfus.back());}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \ \ \ \ sfu\_table[\textcolor{keyword}{static\_cast<}uint\textcolor{keyword}{>}(ISA::RISCV::Type::IMUL)]\ =\ sfus.back();}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ \ \ \ \ sfu\_table[\textcolor{keyword}{static\_cast<}uint\textcolor{keyword}{>}(ISA::RISCV::Type::IDIV)]\ =\ sfus.back();}
\DoxyCodeLine{00186\ }
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \ \ \ \ sfus.push\_back(\_new\ Units::UnitSFU(1,\ 1,\ 20,\ num\_tps\_per\_tm));}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \ \ \ \ simulator.register\_unit(sfus.back());}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ \ \ \ \ sfu\_table[\textcolor{keyword}{static\_cast<}uint\textcolor{keyword}{>}(ISA::RISCV::Type::FDIV)]\ =\ sfus.back();}
\DoxyCodeLine{00190\ }
\DoxyCodeLine{00191\ \ \ \ \ \ \ \ \ \ \ \ \ sfus.push\_back(\_new\ Units::UnitSFU(1,\ 1,\ 20,\ num\_tps\_per\_tm));}
\DoxyCodeLine{00192\ \ \ \ \ \ \ \ \ \ \ \ \ simulator.register\_unit(sfus.back());}
\DoxyCodeLine{00193\ \ \ \ \ \ \ \ \ \ \ \ \ sfu\_table[\textcolor{keyword}{static\_cast<}uint\textcolor{keyword}{>}(ISA::RISCV::Type::FSQRT)]\ =\ sfus.back();}
\DoxyCodeLine{00194\ }
\DoxyCodeLine{00195\ \ \ \ \ \ \ \ \ \ \ \ \ thread\_schedulers.push\_back(\_new\ \ Units::UnitThreadScheduler(num\_tps\_per\_tm,\ tm\_index,\ \&atomic\_regs));}
\DoxyCodeLine{00196\ \ \ \ \ \ \ \ \ \ \ \ \ simulator.register\_unit(thread\_schedulers.back());}
\DoxyCodeLine{00197\ }
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}(uint\ tp\_index\ =\ 0;\ tp\_index\ <\ num\_tps\_per\_tm;\ ++tp\_index)}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Units::UnitTP::Configuration\ tp\_config;}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tp\_config.tp\_index\ =\ tp\_index;}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tp\_config.tm\_index\ =\ tm\_index;}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tp\_config.pc\ =\ elf.elf\_header-\/>e\_entry.u64;}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tp\_config.sp\ =\ stack\_pointer;}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tp\_config.stack\_size\ =\ stack\_size;}
\DoxyCodeLine{00206\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tp\_config.backing\_memory\ =\ mm.\_data\_u8;}
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tp\_config.sfu\_table\ =\ sfu\_table;}
\DoxyCodeLine{00208\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tp\_config.port\_size\ =\ 16;}
\DoxyCodeLine{00209\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tp\_config.mem\_map.add\_unit(mm\_null\_address,\ thread\_schedulers.back(),\ tp\_index,\ 1);}
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tp\_config.mem\_map.add\_unit(mm\_global\_data\_start,\ l1s.back(),\ tp\_index,\ 1);}
\DoxyCodeLine{00211\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tp\_config.mem\_map.add\_unit(mm\_stack\_start,\ \textcolor{keyword}{nullptr},\ 0,\ 0);}
\DoxyCodeLine{00212\ }
\DoxyCodeLine{00213\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tps.push\_back(\textcolor{keyword}{new}\ Units::UnitTP(tp\_config));}
\DoxyCodeLine{00214\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ simulator.register\_unit(tps.back());}
\DoxyCodeLine{00215\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ simulator.units\_executing++;}
\DoxyCodeLine{00216\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00218\ \ \ \ \ \}}
\DoxyCodeLine{00219\ }
\DoxyCodeLine{00220\ \ \ \ \ \{}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ start\ =\ std::chrono::high\_resolution\_clock::now();}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ simulator.execute();}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ stop\ =\ std::chrono::high\_resolution\_clock::now();}
\DoxyCodeLine{00224\ }
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ duration\ =\ std::chrono::duration\_cast<std::chrono::milliseconds>(stop\ -\/\ start);}
\DoxyCodeLine{00226\ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}Runtime:\ "{}}\ <<\ duration.count()\ <<\ \textcolor{stringliteral}{"{}\ ms\(\backslash\)n"{}};}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}Cycles:\ "{}}\ <<\ simulator.current\_cycle\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00228\ \ \ \ \ \}}
\DoxyCodeLine{00229\ }
\DoxyCodeLine{00230\ \ \ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)nTP\(\backslash\)n"{}});}
\DoxyCodeLine{00231\ \ \ \ \ Units::UnitTP::Log\ tp\_log(elf.segments[0]-\/>vaddr);}
\DoxyCodeLine{00232\ \ \ \ \ \textcolor{keywordflow}{for}(\textcolor{keyword}{auto}\&\ tp\ :\ tps)}
\DoxyCodeLine{00233\ \ \ \ \ \ \ \ \ tp\_log.accumulate(tp-\/>log);}
\DoxyCodeLine{00234\ \ \ \ \ tp\_log.print\_log();}
\DoxyCodeLine{00235\ }
\DoxyCodeLine{00236\ \ \ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)nL1\(\backslash\)n"{}});}
\DoxyCodeLine{00237\ \ \ \ \ Units::UnitCache::Log\ l1\_log;}
\DoxyCodeLine{00238\ \ \ \ \ \textcolor{keywordflow}{for}(\textcolor{keyword}{auto}\&\ l1\ :\ l1s)}
\DoxyCodeLine{00239\ \ \ \ \ \ \ \ \ l1\_log.accumulate(l1-\/>log);}
\DoxyCodeLine{00240\ \ \ \ \ l1\_log.print\_log();}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00242\ \ \ \ \ printf(\textcolor{stringliteral}{"{}\(\backslash\)nL2\(\backslash\)n"{}});}
\DoxyCodeLine{00243\ \ \ \ \ Units::UnitCache::Log\ l2\_log;}
\DoxyCodeLine{00244\ \ \ \ \ \textcolor{keywordflow}{for}(\textcolor{keyword}{auto}\&\ l2\ :\ l2s)}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ l2\_log.accumulate(l2-\/>log);}
\DoxyCodeLine{00246\ \ \ \ \ l2\_log.print\_log();}
\DoxyCodeLine{00247\ }
\DoxyCodeLine{00248\ \ \ \ \ mm.print\_usimm\_stats(CACHE\_BLOCK\_SIZE,\ 4,\ simulator.current\_cycle);}
\DoxyCodeLine{00249\ }
\DoxyCodeLine{00250\ \ \ \ \ \textcolor{keywordflow}{for}(\textcolor{keyword}{auto}\&\ tp\ :\ tps)\ delete\ tp;}
\DoxyCodeLine{00251\ \ \ \ \ \textcolor{keywordflow}{for}(\textcolor{keyword}{auto}\&\ sfu\ :\ sfus)\ delete\ sfu;}
\DoxyCodeLine{00252\ \ \ \ \ \textcolor{keywordflow}{for}(\textcolor{keyword}{auto}\&\ l1\ :\ l1s)\ delete\ l1;}
\DoxyCodeLine{00253\ \ \ \ \ \textcolor{keywordflow}{for}(\textcolor{keyword}{auto}\&\ l2\ :\ l2s)\ delete\ l2;}
\DoxyCodeLine{00254\ \ \ \ \ \textcolor{keywordflow}{for}(\textcolor{keyword}{auto}\&\ ts\ :\ thread\_schedulers)\ delete\ ts;}
\DoxyCodeLine{00255\ }
\DoxyCodeLine{00256\ \ \ \ \ paddr\_t\ paddr\_frame\_buffer\ =\ \textcolor{keyword}{reinterpret\_cast<}paddr\_t\textcolor{keyword}{>}(global\_data.framebuffer);}
\DoxyCodeLine{00257\ \ \ \ \ stbi\_flip\_vertically\_on\_write(\textcolor{keyword}{true});}
\DoxyCodeLine{00258\ \ \ \ \ mm.dump\_as\_png\_uint8(paddr\_frame\_buffer,\ global\_data.framebuffer\_width,\ global\_data.framebuffer\_height,\ \textcolor{stringliteral}{"{}out.png"{}});}
\DoxyCodeLine{00259\ \}}
\DoxyCodeLine{00260\ }
\DoxyCodeLine{00261\ \}}

\end{DoxyCode}
